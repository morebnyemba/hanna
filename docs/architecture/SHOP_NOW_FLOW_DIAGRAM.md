# Shop Now Catalog - Complete Flow Diagram

## Visual Flow Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER INTERACTION FLOW                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   USER   â”‚ Sends: "menu" or "hi" or "hello"
â”‚  (Start) â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Main Menu Flow                   â”‚
â”‚   (main_menu_flow.py)              â”‚
â”‚                                    â”‚
â”‚   Shows interactive menu with:     â”‚
â”‚   â€¢ ğŸ›’ Shop Products               â”‚
â”‚   â€¢ ğŸ› ï¸ Request Installation        â”‚
â”‚   â€¢ ğŸ“‹ Book Site Assessment        â”‚
â”‚   â€¢ ... other options              â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ User selects: "Shop Products"
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   switch_to_purchase_flow          â”‚
â”‚   (Step in main_menu_flow.py)      â”‚
â”‚                                    â”‚
â”‚   Triggers Action:                 â”‚
â”‚   send_catalog_message             â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   send_catalog_message()           â”‚
â”‚   (actions.py:561-625)             â”‚
â”‚                                    â”‚
â”‚   â€¢ Gets MetaAppConfig             â”‚
â”‚   â€¢ Retrieves catalog_id           â”‚
â”‚   â€¢ Builds interactive payload     â”‚
â”‚   â€¢ Returns message action         â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ Sends WhatsApp Interactive Message
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   WhatsApp Catalog UI              â”‚
â”‚   (Native WhatsApp Interface)      â”‚
â”‚                                    â”‚
â”‚   User can:                        â”‚
â”‚   â€¢ Browse products                â”‚
â”‚   â€¢ View details & prices          â”‚
â”‚   â€¢ Add items to cart              â”‚
â”‚   â€¢ Adjust quantities              â”‚
â”‚   â€¢ View cart                      â”‚
â”‚   â€¢ Submit order                   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ User submits order
     â”‚ (WhatsApp sends order message)
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Meta Webhook Endpoint            â”‚
â”‚   (views.py:post())                â”‚
â”‚                                    â”‚
â”‚   Receives webhook with:           â”‚
â”‚   â€¢ Message type: "order"          â”‚
â”‚   â€¢ Order data with product_items  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   _handle_message()                â”‚
â”‚   (views.py:419)                   â”‚
â”‚                                    â”‚
â”‚   Detects message_type == "order"  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   _handle_order_message()          â”‚
â”‚   (views.py:419-430)               â”‚
â”‚                                    â”‚
â”‚   Calls:                           â”‚
â”‚   process_order_from_catalog()     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   process_order_from_catalog()     â”‚
â”‚   (services.py)                    â”‚
â”‚                                    â”‚
â”‚   1. Parse order data              â”‚
â”‚   2. Get/create CustomerProfile    â”‚
â”‚   3. Fetch Products by SKU         â”‚
â”‚   4. Generate order number         â”‚
â”‚   5. Calculate total amount        â”‚
â”‚   6. Create Order record           â”‚
â”‚   7. Create OrderItem records      â”‚
â”‚   8. Send confirmation message     â”‚
â”‚   9. Initiate payment flow         â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                 â”‚                  â”‚
     â–¼                 â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Order   â”‚  â”‚ OrderItems  â”‚  â”‚Confirmation  â”‚
â”‚ Created  â”‚  â”‚  Created    â”‚  â”‚Message Sent  â”‚
â”‚          â”‚  â”‚             â”‚  â”‚              â”‚
â”‚WA-12345  â”‚  â”‚Product 1    â”‚  â”‚"ğŸ‰ Thank you â”‚
â”‚Stage:    â”‚  â”‚Product 2    â”‚  â”‚for your      â”‚
â”‚CLOSED_WONâ”‚  â”‚Product 3    â”‚  â”‚order!"       â”‚
â”‚Payment:  â”‚  â”‚             â”‚  â”‚              â”‚
â”‚PENDING   â”‚  â”‚             â”‚  â”‚Order details â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Initiate Payment Flow            â”‚
â”‚   (from process_order_from_catalog â”‚
â”‚    or initiate_payment_flow action)â”‚
â”‚                                    â”‚
â”‚   1. Find published payment flow   â”‚
â”‚   2. Build flow message payload    â”‚
â”‚   3. Send interactive flow         â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ Sends WhatsApp Flow Message
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   WhatsApp Flow UI                 â”‚
â”‚   (Native WhatsApp Flow Interface) â”‚
â”‚                                    â”‚
â”‚   Payment Form:                    â”‚
â”‚   â€¢ Order Number: WA-12345         â”‚
â”‚   â€¢ Amount: $150.00 USD            â”‚
â”‚   â€¢ Payment Method: [Dropdown]     â”‚
â”‚     - Ecocash                      â”‚
â”‚     - OneMoney                     â”‚
â”‚     - Innbucks                     â”‚
â”‚   â€¢ Phone Number: [Input]          â”‚
â”‚   â€¢ Email: [Input]                 â”‚
â”‚   â€¢ [Pay Now] Button               â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ User completes form & submits
     â”‚ (WhatsApp Flow sends data to endpoint)
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Payment Endpoint                 â”‚
â”‚   /api/crm-api/paynow/            â”‚
â”‚   initiate-payment/                â”‚
â”‚   (views.py:56-186)                â”‚
â”‚                                    â”‚
â”‚   1. Validate input fields         â”‚
â”‚   2. Find Order by order_number    â”‚
â”‚   3. Create Payment record         â”‚
â”‚   4. Call PaynowService            â”‚
â”‚   5. Return payment details        â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                 â”‚                   â”‚
     â–¼                 â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Payment  â”‚  â”‚  Paynow     â”‚   â”‚Instructions  â”‚
â”‚ Record   â”‚  â”‚Transaction  â”‚   â”‚Sent to User  â”‚
â”‚ Created  â”‚  â”‚ Initiated   â”‚   â”‚              â”‚
â”‚          â”‚  â”‚             â”‚   â”‚"Please check â”‚
â”‚Status:   â”‚  â”‚Poll URL     â”‚   â”‚your Ecocash  â”‚
â”‚PENDING   â”‚  â”‚created      â”‚   â”‚to complete   â”‚
â”‚          â”‚  â”‚             â”‚   â”‚payment"      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   User Completes Payment           â”‚
â”‚   (In Ecocash/OneMoney/Innbucks)   â”‚
â”‚                                    â”‚
â”‚   â€¢ User receives USSD prompt      â”‚
â”‚   â€¢ User enters PIN                â”‚
â”‚   â€¢ Payment processed              â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ Payment status update
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Paynow IPN Callback              â”‚
â”‚   /api/crm-api/paynow/ipn/         â”‚
â”‚   (views.py:189-285)               â”‚
â”‚                                    â”‚
â”‚   1. Receive IPN data              â”‚
â”‚   2. Verify hash                   â”‚
â”‚   3. Find Payment by reference     â”‚
â”‚   4. Update Payment status         â”‚
â”‚   5. Update Order payment_status   â”‚
â”‚   6. Send confirmation to user     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                 â”‚                   â”‚
     â–¼                 â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Payment  â”‚  â”‚   Order     â”‚   â”‚Confirmation  â”‚
â”‚ Status:  â”‚  â”‚  Payment    â”‚   â”‚Message Sent  â”‚
â”‚SUCCESS   â”‚  â”‚  Status:    â”‚   â”‚              â”‚
â”‚          â”‚  â”‚   PAID      â”‚   â”‚"âœ… Payment   â”‚
â”‚          â”‚  â”‚             â”‚   â”‚Received!"    â”‚
â”‚          â”‚  â”‚             â”‚   â”‚              â”‚
â”‚          â”‚  â”‚             â”‚   â”‚"We will      â”‚
â”‚          â”‚  â”‚             â”‚   â”‚process your  â”‚
â”‚          â”‚  â”‚             â”‚   â”‚order shortly"â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   END: Order Complete & Paid       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Component Interactions

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      COMPONENT DIAGRAM                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   WhatsApp  â”‚ â—„â”€â”€â”€â”€â”€â–º â”‚Meta Webhook  â”‚ â—„â”€â”€â”€â”€â”€â–º â”‚   Contact   â”‚
â”‚     User    â”‚         â”‚   Handler    â”‚         â”‚   Record    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ Flow Service â”‚
                        â”‚  (services)  â”‚
                        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                â”‚                â”‚
        â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
        â”‚  Catalog  â”‚    â”‚  Cart   â”‚    â”‚  Payment  â”‚
        â”‚  Action   â”‚    â”‚ Process â”‚    â”‚   Flow    â”‚
        â”‚           â”‚    â”‚ Action  â”‚    â”‚  Action   â”‚
        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
              â”‚               â”‚                â”‚
              â”‚               â”‚                â”‚
        â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
        â”‚   Meta    â”‚    â”‚  Order  â”‚    â”‚  Payment  â”‚
        â”‚ App Configâ”‚    â”‚  Model  â”‚    â”‚ Endpoint  â”‚
        â”‚           â”‚    â”‚         â”‚    â”‚           â”‚
        â”‚ catalog_idâ”‚    â”‚ Order   â”‚    â”‚ Paynow    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ Item    â”‚    â”‚ Service   â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Database Schema Relationships

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DATA MODEL DIAGRAM                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Contact   â”‚
â”‚            â”‚
â”‚ whatsapp_idâ”‚
â”‚ name       â”‚
â”‚ phone      â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
      â”‚ 1
      â”‚
      â”‚ 1
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Customer   â”‚ 1     * â”‚   Order    â”‚
â”‚  Profile   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚
â”‚            â”‚         â”‚order_numberâ”‚
â”‚ company    â”‚         â”‚name        â”‚
â”‚ lead_score â”‚         â”‚stage       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚payment_statâ”‚
                       â”‚amount      â”‚
                       â”‚currency    â”‚
                       â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ 1
                             â”‚
                             â”‚ *
                             â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚ OrderItem  â”‚ *     1 â”‚  Product   â”‚
                       â”‚            â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚            â”‚
                       â”‚ quantity   â”‚         â”‚ sku        â”‚
                       â”‚ unit_price â”‚         â”‚ name       â”‚
                       â”‚total_amountâ”‚         â”‚ price      â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ category   â”‚
                                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Payment   â”‚ *     1 â”‚   Order    â”‚
â”‚            â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚            â”‚
â”‚reference   â”‚         â”‚            â”‚
â”‚amount      â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚status      â”‚
â”‚provider_id â”‚
â”‚poll_url    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Action Registration Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ACTION REGISTRATION                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Application Startup
       â”‚
       â–¼
flows/actions.py imports
       â”‚
       â”œâ”€â–º Define: send_catalog_message()
       â”‚
       â”œâ”€â–º Define: process_cart_order()
       â”‚
       â”œâ”€â–º Define: initiate_payment_flow()
       â”‚
       â–¼
Bottom of actions.py
       â”‚
       â”œâ”€â–º flow_action_registry.register('send_catalog_message', ...)
       â”‚
       â”œâ”€â–º flow_action_registry.register('process_cart_order', ...)
       â”‚
       â”œâ”€â–º flow_action_registry.register('initiate_payment_flow', ...)
       â”‚
       â–¼
Actions Available for Flow Execution
       â”‚
       â””â”€â–º [2025-12-06 12:06:01] INFO services 
            Registered flow action: 'send_catalog_message'
            Registered flow action: 'process_cart_order'
            Registered flow action: 'initiate_payment_flow'
```

## Message Flow Sequence

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   MESSAGE SEQUENCE DIAGRAM                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User          WhatsApp      Webhook       Flow         Database
 â”‚               â”‚             â”‚          Service         â”‚
 â”‚  "menu"       â”‚             â”‚            â”‚             â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚             â”‚            â”‚             â”‚
 â”‚               â”‚ POST        â”‚            â”‚             â”‚
 â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚            â”‚             â”‚
 â”‚               â”‚             â”‚ process    â”‚             â”‚
 â”‚               â”‚             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚             â”‚
 â”‚               â”‚             â”‚            â”‚ query       â”‚
 â”‚               â”‚             â”‚            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
 â”‚               â”‚             â”‚            â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚               â”‚             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚
 â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚            â”‚             â”‚
 â”‚  Main Menu    â”‚             â”‚            â”‚             â”‚
 â”‚               â”‚             â”‚            â”‚             â”‚
 â”‚ "Shop Products"â”‚            â”‚            â”‚             â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚             â”‚            â”‚             â”‚
 â”‚               â”‚ POST        â”‚            â”‚             â”‚
 â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚            â”‚             â”‚
 â”‚               â”‚             â”‚ execute    â”‚             â”‚
 â”‚               â”‚             â”‚ action     â”‚             â”‚
 â”‚               â”‚             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚             â”‚
 â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚
 â”‚  Catalog UI   â”‚             â”‚            â”‚             â”‚
 â”‚               â”‚             â”‚            â”‚             â”‚
 â”‚ Browse & Add  â”‚             â”‚            â”‚             â”‚
 â”‚               â”‚             â”‚            â”‚             â”‚
 â”‚ Submit Order  â”‚             â”‚            â”‚             â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚             â”‚            â”‚             â”‚
 â”‚               â”‚ POST order  â”‚            â”‚             â”‚
 â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚            â”‚             â”‚
 â”‚               â”‚             â”‚ process    â”‚             â”‚
 â”‚               â”‚             â”‚ order      â”‚             â”‚
 â”‚               â”‚             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚             â”‚
 â”‚               â”‚             â”‚            â”‚ create      â”‚
 â”‚               â”‚             â”‚            â”‚ Order       â”‚
 â”‚               â”‚             â”‚            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
 â”‚               â”‚             â”‚            â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚
 â”‚ Confirmation  â”‚             â”‚            â”‚             â”‚
 â”‚               â”‚             â”‚            â”‚             â”‚
 â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚
 â”‚ Payment Flow  â”‚             â”‚            â”‚             â”‚
```

## Key Files Summary

| Component | File Location | Purpose |
|-----------|---------------|---------|
| **Main Menu** | `flows/definitions/main_menu_flow.py` | Defines Shop Products option |
| **Catalog Action** | `flows/actions.py:561-625` | Sends catalog message |
| **Cart Action** | `flows/actions.py:628-737` | Processes cart from context |
| **Payment Action** | `flows/actions.py:740-831` | Initiates payment flow |
| **Order Service** | `flows/services.py` | Processes orders from webhook |
| **Webhook Handler** | `meta_integration/views.py:419-430` | Routes order messages |
| **Payment Endpoint** | `paynow_integration/views.py:56-186` | Handles payment initiation |
| **IPN Handler** | `paynow_integration/views.py:189-285` | Processes payment callbacks |

## URLs Summary

| Endpoint | URL | Purpose |
|----------|-----|---------|
| **Webhook** | `/webhook/meta/` | Receives all WhatsApp messages |
| **Payment Initiation** | `/api/crm-api/paynow/initiate-payment/` | Starts payment process |
| **IPN Callback** | `/api/crm-api/paynow/ipn/` | Receives payment updates |

---

**Status**: âœ… All components implemented and integrated  
**Last Updated**: 2025-12-06  
**Documentation Version**: 1.0
