[2025-11-09 20:15:12] INFO services Registered flow action: 'create_order'
[2025-11-09 20:15:12] INFO services Registered flow action: 'generate_unique_order_number'
[2025-11-09 20:15:12] INFO services Registered flow action: 'create_order_with_items'
[2025-11-09 20:15:12] INFO services Registered flow action: 'calculate_order_total'
[2025-11-09 20:15:12] INFO services Registered flow action: 'update_order_fields'
[2025-11-09 20:15:12] INFO services Registered flow action: 'update_model_instance'
[2025-11-09 20:15:12] INFO services Registered flow action: 'create_order_from_cart'
[2025-11-09 20:15:12] INFO services Registered flow action: 'generate_unique_assessment_id'
[2025-11-09 20:15:12] INFO services Registered flow action: 'create_placeholder_order'
[2025-11-09 20:15:12] INFO services Registered flow action: 'normalize_order_number'
/usr/local/lib/python3.10/site-packages/google/api_core/_python_version_support.py:266: FutureWarning: You are using a Python version (3.10.19) which Google will stop supporting in new releases of google.api_core once it reaches its end of life (2026-10-04). Please upgrade to the latest Python version, or at least Python 3.11, to continue receiving updates for google.api_core past that date.
  warnings.warn(message, FutureWarning)
/usr/local/lib/python3.10/site-packages/celery/platforms.py:841: SecurityWarning: You're running the worker with superuser privileges: this is
absolutely not recommended!
Please specify a different user using the --uid option.
User information: uid=0 euid=0 gid=0 egid=0
  warnings.warn(SecurityWarning(ROOT_DISCOURAGED.format(
 
 -------------- celery@f068201d72ad v5.5.3 (immunity)
--- ***** ----- 
-- ******* ---- Linux-6.8.0-87-generic-x86_64-with-glibc2.41 2025-11-09 20:15:15
- *** --- * --- 
- ** ---------- [config]
- ** ---------- .> app:         whatsappcrm_backend:0x7924a1293040
- ** ---------- .> transport:   redis://:**@redis:6379/0
- ** ---------- .> results:     
- *** --- * --- .> concurrency: 1 (prefork)
-- ******* ---- .> task events: OFF (enable -E to monitor tasks in this worker)
--- ***** ----- 
 -------------- [queues]
                .> cpu_heavy        exchange=celery(direct) key=cpu_heavy
                
[tasks]
  . conversations.tasks.dispatch_broadcast_task
  . email_integration.fetch_email_attachments_task
  . email_integration.process_attachment_with_gemini
  . email_integration.send_duplicate_invoice_email
  . email_integration.send_receipt_confirmation_email
  . flows.cleanup_idle_conversations_task
  . flows.handle_ai_conversation_task
  . flows.tasks.process_flow_for_message_task
  . media_manager.tasks.check_and_resync_whatsapp_media
  . media_manager.tasks.trigger_media_asset_sync_task
  . meta_integration.download_whatsapp_media_task
  . meta_integration.tasks.send_read_receipt_task
  . meta_integration.tasks.send_whatsapp_message_task
  . notifications.tasks.check_and_send_24h_window_reminders
  . notifications.tasks.dispatch_notification_task
  . paynow_integration.poll_paynow_transaction_status
  . paynow_integration.process_paynow_ipn_task
  . paynow_integration.send_giving_confirmation_whatsapp
  . paynow_integration.send_payment_failure_notification_task
  . stats.broadcast_activity_log
  . stats.broadcast_human_intervention_notification
  . stats.check_handover_timeout
  . stats.update_dashboard_stats
  . warranty.send_manufacturer_notification_task
  . whatsappcrm_backend.celery.debug_task
[2025-11-09 20:15:15,888: INFO/MainProcess] Connected to redis://:**@redis:6379/0
[2025-11-09 20:15:15,903: INFO/MainProcess] mingle: searching for neighbors
[2025-11-09 20:15:16,926: INFO/MainProcess] mingle: all alone
[2025-11-09 20:15:16,942: INFO/MainProcess] celery@f068201d72ad ready.
[2025-11-09 20:15:19,374: INFO/MainProcess] sync with celery@6ee13b36a295
[2025-11-09 20:23:08,884: INFO/MainProcess] Task email_integration.process_attachment_with_gemini[9b283e2a-e0ec-4ff6-b224-6c2a5d292561] received
[2025-11-09 20:23:08,919: INFO/ForkPoolWorker-1] [Gemini File API Task ID: 9b283e2a-e0ec-4ff6-b224-6c2a5d292561] Starting Gemini processing for attachment ID: 86
[2025-11-09 20:23:08,973: INFO/ForkPoolWorker-1] [Gemini File API Task ID: 9b283e2a-e0ec-4ff6-b224-6c2a5d292561] Uploading file to Gemini: /app/mediafiles/attachments/attachments/mailu_209e3f7e105c4c0e8f15594cba4d9692_Sales_Inv_V72vv3U.20251008-140937.pdf
[2025-11-09 20:23:09,651: INFO/ForkPoolWorker-1] HTTP Request: POST https://generativelanguage.googleapis.com/upload/v1beta/files "HTTP/1.1 200 OK"
[2025-11-09 20:23:11,223: INFO/ForkPoolWorker-1] HTTP Request: POST https://generativelanguage.googleapis.com/upload/v1beta/files?upload_id=AOCedOE9FHtwKx6LeRY7t7lL9kvyOFbhLUYUXm5mPe6Bjdf0qh_FwDOmWygh9VG2dpekcNmbuynUm6PyM-n0wSViAiL1ZGajHsKrBzmGq-gS9g&upload_protocol=resumable "HTTP/1.1 200 OK"
[2025-11-09 20:23:11,225: INFO/ForkPoolWorker-1] [Gemini File API Task ID: 9b283e2a-e0ec-4ff6-b224-6c2a5d292561] File uploaded successfully. URI: https://generativelanguage.googleapis.com/v1beta/files/kg91q4k0j7z4
[2025-11-09 20:23:11,225: INFO/ForkPoolWorker-1] [Gemini File API Task ID: 9b283e2a-e0ec-4ff6-b224-6c2a5d292561] Sending request to Gemini model for analysis.
[2025-11-09 20:23:11,225: INFO/ForkPoolWorker-1] AFC is enabled with max remote calls: 10.
[2025-11-09 20:23:21,884: INFO/ForkPoolWorker-1] HTTP Request: POST https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent "HTTP/1.1 200 OK"
[2025-11-09 20:23:21,886: INFO/ForkPoolWorker-1] [Gemini File API Task ID: 9b283e2a-e0ec-4ff6-b224-6c2a5d292561] Gemini identified document as type: 'invoice'
[2025-11-09 20:23:21,886: INFO/ForkPoolWorker-1] [Gemini File API Task ID: 9b283e2a-e0ec-4ff6-b224-6c2a5d292561] Starting to create Order from extracted data.
[2025-11-09 20:23:21,908: INFO/ForkPoolWorker-1] [Gemini File API Task ID: 9b283e2a-e0ec-4ff6-b224-6c2a5d292561] Created new CustomerProfile for 'TASA NEWMAN'.
[2025-11-09 20:23:21,930: INFO/ForkPoolWorker-1] Logged creation of placeholder order ID c6b83c78-ea91-40fd-9088-547e0afa4aef (no customer attached).
[2025-11-09 20:23:21,936: INFO/ForkPoolWorker-1] [Gemini File API Task ID: 9b283e2a-e0ec-4ff6-b224-6c2a5d292561] Created new Order with order_number 'IC01/0014739'.

[2025-11-09 20:23:21,938: ERROR/ForkPoolWorker-1] [Gemini File API Task ID: 9b283e2a-e0ec-4ff6-b224-6c2a5d292561] An unexpected error occurred during Gemini processing for attachment 86: InstallationRequest() got unexpected keyword arguments: 'order', 'preferred_date'
Traceback (most recent call last):
  File "/app/email_integration/tasks.py", line 285, in process_attachment_with_gemini
    _create_order_from_invoice_data(attachment, data, log_prefix)
  File "/usr/local/lib/python3.10/contextlib.py", line 79, in inner
    return func(*args, **kwds)
  File "/app/email_integration/tasks.py", line 417, in _create_order_from_invoice_data
    InstallationRequest.objects.create(
  File "/usr/local/lib/python3.10/site-packages/django/db/models/manager.py", line 87, in manager_method
    return getattr(self.get_queryset(), name)(*args, **kwargs)
  File "/usr/local/lib/python3.10/site-packages/django/db/models/query.py", line 663, in create
    obj = self.model(**kwargs)
  File "/usr/local/lib/python3.10/site-packages/django/db/models/base.py", line 569, in __init__
    raise TypeError(
TypeError: InstallationRequest() got unexpected keyword arguments: 'order', 'preferred_date'
[2025-11-09 20:23:21,943: INFO/ForkPoolWorker-1] [Gemini File API Task ID: 9b283e2a-e0ec-4ff6-b224-6c2a5d292561] Deleting temporary file from Gemini service: files/kg91q4k0j7z4
[2025-11-09 20:23:23,283: INFO/ForkPoolWorker-1] HTTP Request: DELETE https://generativelanguage.googleapis.com/v1beta/files/kg91q4k0j7z4 "HTTP/1.1 200 OK"
[2025-11-09 20:23:23,292: INFO/ForkPoolWorker-1] Task email_integration.process_attachment_with_gemini[9b283e2a-e0ec-4ff6-b224-6c2a5d292561] succeeded in 14.405084862002695s: None