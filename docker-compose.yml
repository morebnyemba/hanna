services:
  db:
    image: postgres:15-alpine
    container_name: whatsappcrm_db
    volumes:
      - postgres_data:/var/lib/postgresql/data/
    environment:
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    ports:
      - "5432:5432"
    restart: unless-stopped # Ensure that the DB restarts unless explicitly stopped

  redis:
    image: redis:7-alpine
    container_name: whatsappcrm_redis
    command: redis-server /usr/local/etc/redis/redis.conf # Use config file for redis
    # redis-server --requirepass your_strong_password
    volumes:
      - redis_data:/data
      - ./redis.conf:/usr/local/etc/redis/redis.conf
    ports: # Ensure the ports are accessible to the host if needed
      - "6379:6379"
    restart: unless-stopped # Ensure redis restarts unless explicitly stopped


  # --- Mailu Mail Server Services (2.x) ---
  mailu_front:
    image: mailu/nginx:1.9
    restart: always
    env_file: .env.mailu
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./mailu/certs:/certs
      - ./mailu/overrides:/overrides
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - mailu_admin
      - mailu_imap
      - mailu_smtp

  mailu_admin:
    image: mailu/admin:1.9
    restart: always
    env_file: .env.mailu
    volumes:
      - ./mailu/data:/data

  mailu_imap:
    image: mailu/dovecot:1.9
    restart: always
    env_file: .env.mailu
    volumes:
      - ./mailu/mail:/mail
      - ./mailu/overrides:/overrides

  mailu_smtp:
    image: mailu/postfix:1.9
    restart: always
    env_file: .env.mailu
    # No volumes needed for mailu_smtp by default
